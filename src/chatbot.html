<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Chatbot</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script>var exports = {};</script>
    <!-- TODO: Properly import the sse.js file -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <!-- and it's easy to individually load additional languages -->
    <link rel="stylesheet" href="{{colorsUri}}" />
    <link rel="stylesheet" href="{{chatUri}}" />
</head>

<body>

    <div class="msger">
        <div class="head-bar">
            <div>
                <p class="title">GPT-4</p>
            </div>
            <div>
                <button class="new-chat-btn">
                    <img class="new-chat-img" src="{{newbutton}}"
                        alt="Toggle Theme">
                </button>
                <button class="theme-btn">
                    <img class="theme-img" src="{{buttonimage}}"
                        alt="Toggle Theme">
                </button>
            </div>
        </div>

        <!-- <main class="msger-chat" onscroll="handle_auto_scroll()"> -->
        <main class="msger-chat">
        </main>

        <div class="chat-bubble">
            <span class="typing-text">typing</span>
            <div class="typing">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>

        <div class="context-display">
            <p class="context-selection"></p>
        </div>
        <form class="msger-inputarea">
            <textarea type="text" class="msger-input" id="textInput" autocomplete="off"
                placeholder="Geben Sie eine Nachricht ein..."></textarea>
            <button type="submit" class="msger-send-btn">
                <img class="theme-img" src="{{sendicon}}"
                    alt="Send Message">
            </button>
        </form>
    </div>
    </div>
    <!-- partial -->
    <script src="https://use.fontawesome.com/releases/v5.0.13/js/all.js"></script>
    <script>
        const msgerForm = get(".msger-inputarea");
        const msgerInput = get(".msger-input");
        const msgerInputArea = get(".msger-inputarea");
        const msgerChat = get(".msger-chat");
        const msgLoadingSpinner = get(".loading-spinner-area");
        const msgLoader = get(".chat-bubble");
        const contextDisplay = get(".context-display");
        const contextSelection = get(".context-selection");
        const title = get(".title");
        const themeBtn = get(".theme-btn")
        const themeImg = get(".theme-img")
        const newChatBtn = get(".new-chat-btn")

        // Icons made by Freepik from www.flaticon.com
        const BOT_IMG = "url({{botimage}})";
        const PERSON_IMG = 'url({{userimage}})';
        const DARKMODE_IMAGE = "{{darkmodeimage}}";
        const LIGHTMODE_IMAGE = "{{lightmodeimage}}";
        console.log(BOT_IMG)

        const BOT_INTERNAL_NAME = "assistant";
        const BOT_DISPLAY_NAME = "Assistant";
        const USER_DISPLAY_NAME = "You";
        const USER_INTERNAL_NAME = "user";

        var conversation_messages = []

        let conversation_id = crypto.randomUUID();//parseInt("{{ conversation_id }}");
        let current_bot_message = "";
        var auto_scroll = true;

        $('#textInput').keydown(function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        if (localStorage.getItem('darkmode')) {
            document.body.classList.add('darkmode');
            themeImg.src = DARKMODE_IMAGE;
        } else {
            themeImg.src = LIGHTMODE_IMAGE;
        }

        themeBtn.addEventListener('click', function (e) {
            e.preventDefault;

            if (document.body.classList.contains('darkmode')) {
                // Turn off
                document.body.classList.remove('darkmode')
                // Switch to light mode
                themeImg.src = LIGHTMODE_IMAGE;
                localStorage.removeItem('darkmode')
            }
            else {
                document.body.classList.add('darkmode');
                themeImg.src = DARKMODE_IMAGE;
                localStorage.setItem('darkmode', true)
            }
        })

        newChatBtn.addEventListener('click', function (e) {
            e.preventDefault;
            //var response = confirm("Are you sure you want to start a new chat? This will delete the current conversation.");
            //if (response) {
                conversation_messages = [];
                conversation_id = crypto.randomUUID();
                msgerChat.innerHTML = "";
                display_current_messages();
            //}
        })

        msgerForm.addEventListener('submit', function (event) {
            event.preventDefault();
            sendMessage();
        });

        window.addEventListener('message', event => {
            const message = event.data; // The JSON data our extension sent
            switch (message.command) {
                case 'update':
                    const text = message.text;
                    const filename = message.filename;
                    const startLine = message.startLine;
                    const endLine = message.endLine;
                    // Call your updateWebview function
                    updateWebview(text, filename, startLine, endLine);
                    break;
                case 'setConfig':
                    window.endpoint = message.endpoint;
                    window.apiKey = message.apiKey;
                    window.model = message.model;
                    window.temperature = message.temperature;
                    break;
            }
        });

        function display_current_messages() {
            if (this.conversation_messages.length === 0) {
                conversation_messages = [{ "role": BOT_INTERNAL_NAME, "content": "I am your helpful assistant!", "id": crypto.randomUUID(), "date": formatDate(new Date()) }]
            }
            msgLoader.style.display = "none";
            this.conversation_messages.forEach((message) => {
                appendMessage(message["role"], message["content"], message["id"], message["date"]);
            })
        }

        function handle_auto_scroll() {
            auto_scroll = (msgerChat.scrollTop === (msgerChat.scrollHeight - msgerChat.offsetHeight))
        }

        function sendMessage() {

            console.log("Sending message...")
            const msgText = msgerInput.value;
            if (!msgText) return;

            console.log(msgText)
            current_prompt = msgText

            appendMessage(USER_INTERNAL_NAME, msgText, crypto.randomUUID(), formatDate(new Date()));
            getBotResponse(msgText);

            msgerInput.value = '';
            msgerInput.style.height = 'auto';

        }

        function appendMessage(name, text, id, datetime) {

            this.conversation_messages.push({ "role": name, "content": text, "id": id, "date": datetime })
            let img = "";
            let class_name = "";
            let display_name = "";
            let display_text = "";


            let msgHTML = ""

            if (name === BOT_INTERNAL_NAME) {
                img = BOT_IMG
                class_name = BOT_INTERNAL_NAME
                display_name = BOT_DISPLAY_NAME
                console.log(text)
                display_text = marked.parse(text)
                console.log(display_text)
            } else if (name === USER_INTERNAL_NAME) {
                img = PERSON_IMG;
                class_name = USER_INTERNAL_NAME;
                display_name = USER_DISPLAY_NAME;
                display_text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>').replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;').replace(/ /g, '&nbsp;');
            }


            msgHTML = `
        
            <div class="msg ${class_name}-msg" >
            <div class="msg-img" style="background-image: ${img}"></div>
            <div class="msg-bubble">
                <div class="msg-info">
                    <div class="msg-info-name">${display_name}</div>
                        <div>
                        <div class="msg-info-time">${datetime}</div>
                        </div>
                    </div>
        
                    <div class="msg-text" id=${id}>${display_text}</div>
                </div>
            </div>`;

            msgerChat.insertAdjacentHTML("beforeend", msgHTML);
            msgerChat.scrollTop = msgerChat.scrollHeight;
        }

        function getUpdatedConversations() {
            updated_messages = this.conversation_messages;
            if (selectedCode) {
                let lastMessageIndex = this.conversation_messages.length - 1;
                if (updated_messages[lastMessageIndex].role === USER_INTERNAL_NAME) {
                    current_content = updated_messages[lastMessageIndex].content;
                    updated_messages[lastMessageIndex].content = `${current_content} The user sent this code with their request: \`\`\`${selectedCode}\`\`\``;
                }
            }
            return updated_messages;
        }

        function prepareMessagesForGPT(messages) {
            // Drop all values in each message in the message array except for role and content
            return messages.map((message) => {
                return {
                    role: message.role,
                    content: message.content
                }
            });
        }

        async function getBotResponse(userInput) {
            msgerInputArea.style.display = "none";
            msgLoader.style.display = "inline-flex";
            
            console.log(msgerInputArea)
            console.log(msgerInputArea.style.display)

            // Bot Response
            updated_repsonse = getUpdatedConversations();
            payload_response = prepareMessagesForGPT(updated_repsonse);
            payload = {
                "model": window.model,
                "messages": payload_response,
                "temperature": window.temperature
            }
            id = crypto.randomUUID()
            console.log(JSON.stringify(payload))
            console.log(window.endpoint)

            fetch(`${window.endpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${window.apiKey}`
                },
                body: JSON.stringify(payload)
            })
                .then(response => response.json())
                .then(data => {
                    // Assuming data contains a property 'text' with the response message
                    console.log(data);
                    response = data["choices"][0]["message"]["content"]
                    if (data && response) {
                        appendMessage(BOT_INTERNAL_NAME, response, id, formatDate(new Date()));
                    } else {
                        appendMessage(BOT_INTERNAL_NAME, "There was an error in generating the reply. If this continues, please check if all settings are correct inputted and stored.", id, formatDate(new Date()));
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    appendMessage(BOT_INTERNAL_NAME, "There was an error in generating the reply. If this continues, please check if all settings are correctly inputted and stored.", id, formatDate(new Date()));
                })
                .finally(() => {
                    // Reset display states after fetch operation completes or fails
                    msgerInputArea.style.display = "flex";
                    msgLoader.style.display = "none";
                });
        }

        function showAllFeedbackButtons() {
            btns = document.getElementsByClassName("feedback-button");
            for (i = 0; i < btns.length; i++) {
                btns[i].style.display = "flex";
            }
        }

        function copyToClipboard(button) {
            const pre = button.parentNode;
            const text = pre.textContent.replace(button.textContent, "");
            navigator.clipboard.writeText(text).then(() => {
                console.log('Copied to clipboard');
            }).catch((error) => {
                console.error('Failed to copy to clipboard: ', error);
            });
        }

        function copyPromptToClipboard(input) {
            const str = input.parentNode.textContent;
            const matches = str.match(/"([^"]+)"/);
            const text = matches[1];
            navigator.clipboard.writeText(text).then(() => {
                console.log('Copied to clipboard');
            }).catch((error) => {
                console.error('Failed to copy to clipboard: ', error);
            });
        }

        // Utils
        function get(selector, root = document) {
            return root.querySelector(selector);
        }

        function formatDate(date) {
            const h = "0" + date.getHours();
            const m = "0" + date.getMinutes();

            return `${h.slice(-2)}:${m.slice(-2)}`;
        }

        const tx = document.getElementsByTagName("textarea");
        for (let i = 0; i < tx.length; i++) {
            tx[i].setAttribute("style", "height:" + (tx[i].scrollHeight) + "px;overflow-y:hidden;");
            tx[i].addEventListener("input", OnInput, false);
        }

        function OnInput() {
            this.style.height = 0;
            this.style.height = (this.scrollHeight) + "px";
        }

        const input = document.getElementById('input');
        const messages = document.getElementById('messages');
        let selectedCode = "";

        function updateWebview(text, filename, startLine, endLine) {
            selectedCode = text;

            if (selectedCode === "") {
                contextDisplay.style.display = "none";
            } else {
                contextDisplay.style.display = "flex";
                contextSelection.innerHTML = `${filename}: lines ${startLine}-${endLine} is sent to the model as context.`;
            }
        }

        display_current_messages();
        title.innerHTML = "Chat";

    </script>
</body>

</html>